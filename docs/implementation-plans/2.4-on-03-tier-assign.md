---
name: ON-03 티어 배정 (Tier Assignment)
overview: 온보딩 Step 2. 선택한 홈짐의 색상 중 "한 세션에 50% 이상 완등 가능한 난이도"를 선택하면 해당 색상이 매핑된 티어(1~6)를 사용자에게 배정하고 저장. PRD 3.1 [Step 2], TODO 2.4, userflow Step 2 반영. DB는 profiles.current_tier 또는 users 테이블 current_tier 사용.
status: 계획 수립
todo_ref: docs/TODO.md § 2.4
---

# ON-03: 티어 배정 (Tier Assignment) MVP 구현 계획

> **상태**: 계획 수립 (TODO 2.4)
> **관리 위치**: 이 문서는 `docs/implementation-plans/`에서 관리됩니다.

---

## 1. 요구사항 정리

| 출처             | 내용                                                                                                                                          |
| ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------- |
| PRD 3.1 [Step 2] | 선택한 홈짐의 색상 중 **"1세션 기준 50% 이상 완등 가능한 색상"** 선택. Tier 1(Silver)~6(Grandmaster) 매핑 로직 명시.                          |
| TODO 2.4         | tier-assign 페이지, 색상 그리드(sort_order 정렬), 안내 문구, 티어 뱃지 즉시 표시(Bounce/Fade-in), [다음] 버튼. ColorGrid, TierBadge 컴포넌트. |
| userflow Step 2  | 홈짐 선택 완료 → 티어 선택 화면 → 50% 완등 가능 색상 선택 → 티어 배정 완료.                                                                   |
| DB 스키마        | `profiles.current_tier` int 1~6 (setup_schema). 실제 운영은 `users` 테이블에 current_tier 존재 여부에 따라 동기화 필요.                       |

**티어 매핑 (PRD/TODO 기준)**

| 티어        | 색상 범위 | 값  |
| ----------- | --------- | --- |
| Silver      | 흰~주     | 1   |
| Gold        | 초~파     | 2   |
| Platinum    | 빨~핑     | 3   |
| Diamond     | 보라~갈   | 4   |
| Master      | 회색      | 5   |
| Grandmaster | 검정      | 6   |

**진입 조건**: 홈짐이 이미 선택된 상태 (gym-select에서 선택 완료 또는 gym-create 저장 후 리다이렉트). 홈짐 미선택 시 tier-assign 진입 시에는 gym-select로 보내거나, Guest는 tier-assign 스킵 처리 정책에 따름.

**디자인 레퍼런스**: `docs/design-refs/04_tier_assign.html`은 수행 능력 측정(Assessment) UI로 되어 있어, 티어 배정 전용 픽셀 레퍼런스는 없음. 02_gym_select·03_gym_create와 동일한 톤(다크 배경, primary 컬러, 상단 앱바)으로 구현.

---

## 2. 아키텍처 및 데이터 흐름

```mermaid
flowchart TD
  subgraph page [tier-assign 페이지]
    A["/onboarding/tier-assign 진입"] --> B{홈짐 있음?}
    B -->|없음| C["/onboarding/gym-select 리다이렉트"]
    B -->|있음| D[홈짐의 gym_grade_scales 조회]
    D --> E[ColorGrid: sort_order 기준 색상 버튼]
    E --> F[유저가 한 색상 선택]
    F --> G[선택한 scale의 tier_level → 티어 뱃지 표시]
    G --> H[TierBadge Bounce/Fade-in]
    H --> I[[다음] 클릭]
    I --> J[setCurrentTier(tier_level)]
    J --> K[profiles 또는 users 업데이트]
    K --> L["/onboarding/assessment"]
  end
```

- **데이터 소스**: 현재 사용자의 `home_gym_id`로 해당 gym의 `gym_grade_scales` 조회. `sort_order` 기준 정렬하여 색상 버튼 표시.
- **선택 결과**: 한 개 색상만 선택 가능. 선택한 scale의 `tier_level`(1~6)을 `current_tier`로 저장.
- **다음 단계**: 저장 성공 시 `/onboarding/assessment`(ON-04)로 이동.

---

## 3. 구현 범위 (TODO 2.4 기준)

### 3.1 라우트 및 페이지

- **파일**: `app/onboarding/tier-assign/page.tsx`
- **경로**: `/onboarding/tier-assign`
- **역할**: 홈짐 scales 로드, ColorGrid·TierBadge 배치, 안내 문구, [다음] 시 setCurrentTier → assessment 이동.

### 3.2 UI 요소

| 요소        | 구현 내용                                                                                 |
| ----------- | ----------------------------------------------------------------------------------------- |
| 상단        | 뒤로가기(→ gym-select), "티어 배정" 타이틀                                                |
| 안내 문구   | "한 세션에 50% 이상 완등 가능한 난이도의 색상을 선택하세요" (TODO 문구 반영)              |
| 색상 그리드 | 선택한 홈짐의 색상 버튼. `gym_grade_scales`를 `sort_order` 기준 정렬. 선택 시 하이라이트. |
| 티어 뱃지   | 선택 즉시 해당 티어(Silver~Grandmaster) 뱃지 표시. Bounce 또는 Fade-in 애니메이션.        |
| 하단        | [다음] 버튼. 색상 미선택 시 비활성화.                                                     |

### 3.3 Server Actions

- **actions/profiles.ts** (또는 actions/onboarding.ts) 확장:
  - `setCurrentTier(tier: 1|2|3|4|5|6)`: 현재 사용자의 `current_tier` 업데이트.
  - 저장 대상: `profiles.current_tier`(database.types 기준) 또는 Clerk 동기화용 `users` 테이블에 `current_tier` 컬럼이 있으면 해당 테이블 업데이트. (현재 코드베이스는 setHomeGym가 `users` 사용 → 동일하게 `users`에 current_tier 컬럼 추가 후 업데이트할지, profiles만 사용할지 정책 결정 필요.)
- **actions/gyms.ts** (또는 profiles에서 홈짐 조회):
  - 홈짐의 색상 목록 조회: `getScalesByGymId(gymId: string)` → `gym_grade_scales[]` (sort_order 순).

### 3.4 컴포넌트

| 컴포넌트                                | 역할                                                                                                                                               |
| --------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| **components/onboarding/ColorGrid.tsx** | 선택한 홈짐의 색상 버튼 그리드. `sort_order` 정렬. 선택 상태 하이라이트(ring/border). 단일 선택만 허용.                                            |
| **components/common/TierBadge.tsx**     | 6단계 티어 뱃지 디자인. `lib/utils/tier.ts`의 TIER_NAMES, TIER_NAMES_KO, TIER_COLORS 활용. Bounce/Fade-in 애니메이션( CSS 또는 framer-motion 등 ). |

### 3.5 데이터 구조

- **gym_grade_scales**: `gym_id`, `color_name`, `color_hex`, `tier_level`, `sort_order`. 페이지에서는 `sort_order` 오름차순 정렬.
- **저장 payload**: `setCurrentTier(tierLevel)` — 1~6 숫자만 전달.

---

## 4. 파일별 작업 요약

| #   | 작업                                | 파일/위치                                           |
| --- | ----------------------------------- | --------------------------------------------------- |
| 1   | setCurrentTier(tier) 추가           | actions/profiles.ts (또는 users 테이블 정책에 맞춰) |
| 2   | getScalesByGymId(gymId) 추가        | actions/gyms.ts                                     |
| 3   | tier-assign 페이지 본 구현          | app/onboarding/tier-assign/page.tsx                 |
| 4   | ColorGrid (색상 버튼, 단일 선택)    | components/onboarding/ColorGrid.tsx                 |
| 5   | TierBadge (6단계 뱃지 + 애니메이션) | components/common/TierBadge.tsx                     |

**선택**: `users` 테이블에 `current_tier` 컬럼이 없다면 마이그레이션 추가. 현재 setHomeGym가 `users`를 쓰므로, 티어도 `users.current_tier`로 통일하면 프로필 정보가 한 테이블에 모임.

---

## 5. 기술적 유의사항

- **홈짐 미선택**: tier-assign 진입 시 `home_gym_id`가 없으면 `/onboarding/gym-select`로 리다이렉트. Guest가 URL로 직접 tier-assign 접근 시에도 동일 처리 또는 "홈짐을 먼저 선택하세요" 안내 후 gym-select로 이동.
- **티어 뱃지 애니메이션**: TODO에서 "Bounce/Fade-in" 명시. CSS `animation` 또는 `framer-motion` 등으로 선택 직후 한 번 재생. 과도한 모션은 피하고 접근성( prefers-reduced-motion ) 고려.
- **티어 유틸**: `lib/utils/tier.ts`의 `getTierName`, `getTierColor`, `TIER_NAMES_KO` 등 재사용. TierBadge는 이 모듈과 일치시키기.
- **current_tier 저장 위치**: `database.types.ts`에는 `profiles.current_tier`만 정의됨. 실제 Clerk 연동은 `users` 테이블 사용. 따라서 (1) `users`에 `current_tier` 컬럼 추가 후 setCurrentTier에서 users 업데이트, 또는 (2) profiles 테이블을 현재 사용자와 매핑해 profiles.current_tier 업데이트. 팀 정책에 따라 결정 후 구현.

---

## 6. 구현 순서

1. **DB 정책 확정**: current_tier를 `users`에 둘지 `profiles`에 둘지 결정. 필요 시 `users`에 `current_tier int check (current_tier between 1 and 6)` 마이그레이션 추가.
2. **actions/profiles.ts**: `setCurrentTier(tier: 1|2|3|4|5|6)` 구현. (auth → userId → 해당 레코드 업데이트.)
3. **actions/gyms.ts**: `getScalesByGymId(gymId)` 구현. `gym_grade_scales`에서 `gym_id`로 조회, `sort_order` 오름차순.
4. **TierBadge.tsx**: 6단계 뱃지 UI + 선택 시 Bounce/Fade-in. tier.ts 연동.
5. **ColorGrid.tsx**: scales 배열 prop, 단일 선택 콜백, 선택 시 하이라이트.
6. **tier-assign/page.tsx**: 홈짐 여부 확인 → scales 로드 → ColorGrid·TierBadge·안내 문구·[다음] 배치. [다음] 클릭 시 setCurrentTier → `/onboarding/assessment` 이동.

---

## 7. 체크리스트 (TODO 2.4 대응)

- [x] `app/onboarding/tier-assign/page.tsx` — 색상 그리드, 안내 문구, 티어 뱃지, [다음] 버튼
- [x] `components/onboarding/ColorGrid.tsx` — 홈짐 색상 버튼, sort_order 정렬, 선택 하이라이트
- [x] `components/common/TierBadge.tsx` — 6단계 뱃지, Bounce/Fade-in
- [x] `actions/profiles.ts` — setCurrentTier(tier), getCurrentUserHomeGym (users 테이블)
- [x] `actions/gyms.ts` — getScalesByGymId(gymId)
- [x] 마이그레이션 — users.current_tier 컬럼 추가 (20250203130000_add_users_current_tier.sql)
