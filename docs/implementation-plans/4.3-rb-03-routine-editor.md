---
name: RB-03 루틴 에디터 MVP
overview: 중첩 구조(Nested Loop)를 지원하는 루틴 에디터를 구현합니다.
status: 진행 중
todo_ref: docs/TODO.md § 4.3
---

# RB-03: 루틴 에디터 (Block Editor) MVP 구현 계획

> **상태**: 진행 중 (TODO 4.3)  
> **관리 위치**: `docs/implementation-plans/`

---

## 1. 개요
사용자가 직접 운동 루틴을 생성하고 수정할 수 있는 에디터입니다.
단순한 리스트가 아닌 **중첩 구조(Nested Structure)**를 지원하여, "운동 + 휴식"을 묶어서 반복하는 등의 복잡한 루틴을 구성할 수 있어야 합니다.

## 2. 요구사항 정리

| 출처 | 내용 |
|------|------|
| PRD 3.2 | Custom Builder: 블록 기반 편집, 드래그 앤 드롭, 중첩 반복(Loop) 지원. |
| Design Ref | [10_routine_editor.html](../design-refs/10_routine_editor.html): 헤더, 블록 리스트, 하단 통계 패널, 타임라인 그래프. |
| DB Schema | `routines.structure_json` (jsonb) 필드에 트리 구조로 저장. |

---

## 3. 데이터 구조 (Types)

`types/routine.ts`를 생성하여 구체적인 타입을 정의합니다.

```typescript
export type BlockType = "exercise" | "rest" | "loop";

export interface BaseBlock {
  id: string; // UUID (프론트엔드 생성)
  type: BlockType;
}

export interface ExerciseBlock extends BaseBlock {
  type: "exercise";
  name: string;
  duration: number; // 초 단위
  reps?: number;
  weight?: number;
}

export interface RestBlock extends BaseBlock {
  type: "rest";
  duration: number;
}

export interface LoopBlock extends BaseBlock {
  type: "loop";
  repeat: number;
  children: RoutineBlock[]; // 중첩 구조
}

export type RoutineBlock = ExerciseBlock | RestBlock | LoopBlock;
```

---

## 4. 아키텍처 및 상태 관리

전역 상태(Jotai/Zustand) 대신 **Page Level Context**를 사용하여 에디터 내에서만 상태를 관리합니다.

```mermaid
flowchart TD
    Page[app/routine-builder/editor/page.tsx] --> Provider[RoutineEditorProvider]
    Provider --> Header[EditorHeader]
    Provider --> Main[BlockList (Root)]
    Provider --> Footer[EditorFooter]
    
    Main -->|Render| Item[BlockItem]
    Item -->|If Loop| SubList[BlockList (Nested)]
    
    subgraph Context [RoutineEditorContext]
        State[Routine Blocks Tree]
        Actions[addBlock, removeBlock, updateBlock, moveBlock]
    end
```

### 4.1 상태 관리 (useRoutineEditor)
- **Actions**:
  - `addBlock(parentId, block)`: 블록 추가
  - `updateBlock(blockId, data)`: 블록 수정
  - `removeBlock(blockId)`: 블록 삭제
  - `reorderBlocks(parentId, activeId, overId)`: 드래그 앤 드롭 순서 변경

---

## 5. 구현 범위 및 순서

### 5.1 타입 및 유틸리티
- [ ] `types/routine.ts`: 블록 타입 정의
- [ ] `lib/utils/routine-calc.ts`: 루틴 총 시간, TUT 계산 로직 (재귀)

### 5.2 상태 관리 및 컨텍스트
- [ ] `components/routine-builder/editor/RoutineEditorContext.tsx`: Context & Reducer 구현

### 5.3 컴포넌트 구현
- [ ] `components/routine-builder/editor/BlockItem.tsx`:
  - 운동/휴식/루프 블록별 UI 분기
  - `dnd-kit` Sortable 적용
- [ ] `components/routine-builder/editor/BlockList.tsx`:
  - `SortableContext` 래핑
  - 재귀적 렌더링 지원
- [ ] `components/routine-builder/editor/EditorFooter.tsx`:
  - 통계 표시 (총 시간, 세트 수)
  - 블록 추가 버튼 (Floating or Fixed)
- [ ] `components/routine-builder/editor/VisualTimeline.tsx`:
  - 루틴 구조를 막대 그래프로 시각화

### 5.4 페이지 및 서버 액션
- [ ] `app/routine-builder/editor/page.tsx`: 에디터 레이아웃 조립
- [ ] `actions/routines.ts`:
  - `saveRoutine(routineData)`: DB 저장 (JSON 변환)

---

## 6. UI 상세 (Design Ref 반영)

- **헤더**: 뒤로가기, 제목 입력, 저장 버튼
- **블록 아이템**:
  - **운동**: 파란색 포인트, 시간 표시, 삭제 버튼
  - **휴식**: 초록색 포인트, "RECOVERY" 라벨
  - **루프**: 테두리로 그룹핑, 반복 횟수 설정 헤더
- **하단 패널**:
  - Glassmorphism 효과
  - 실시간 통계 업데이트
  - 타임라인 그래프 (Canvas or CSS Grid)

---

## 7. 기술적 고려사항

- **dnd-kit**: 중첩된 Sortable 리스트 구현 시 `SortableContext`의 id 충돌 주의.
- **재귀 계산**: 총 소요시간 계산 시 Loop 블록의 `repeat` 횟수를 곱해서 재귀적으로 합산해야 함.
- **모바일 최적화**: 드래그 핸들 영역을 명확히 하여 스크롤과 간섭 방지.
